(py312) lee@AI-LAP:~/Desktop/myQuantTF$ python -u main_TFquant.py 

- main_args params:
    - arch: ViT_B_16
    - batch_size: 128
    - num_samples: 1024

- weight params:
    - scheme: AbsMaxQuantizer
    - bit_width: 4
    - per_channel: True

- activation params:
    - scheme: MovAvgAbsMaxQuantizer
    - bit_width: 8
    - idadd_bit_width: 18
    - per_channel: False
    - momentum: 0.95
    - batches: 4
    - Identity addition : INT16 (The input of each LayerNorm)

- softmax params:
    - bit_width: 17
    - left_shift_for_exp: 15
    - act_quant_bit_width: 4
    - Activation of Softmax(Q@K/d_K) (attn_map) : UINT8

- layer_norm params:
    - using: True

- gelu params:
    - sigmoid_bit_width: 8
    - left_shift_for_exp: 23
    - act_quant_bit_width: 8

IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
IntSoftMax | output bit : 17, exp Lshift : 15
Int log_sqrt_2 quantizer | output bit : 4
IntGELU    | sigmoid bit: 8, exp Lshift: 23
Training model for calibration...
  0%|                                                               | 0/391 [00:00<?, ?it/s]Score : 985074.9375
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 4765246.5
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 4529770.5
- diff norm : 985074.9375


Score : 1114727.25
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 5409468.5
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 5232409.5
- diff norm : 1114727.25


Score : 2253640.5
best bias : tensor([1.], device='cuda:0'), best k : 1.399999976158142
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.2000e+01, 1.4900e+02, 3.0700e+02, 6.2900e+02, 1.2880e+03, 2.6370e+03,
        5.3970e+03, 1.1047e+04, 2.2608e+04, 4.6270e+04], device='cuda:0')

-org input INT domain tensor norm : 11987835.0
forward unique : 16
lognum : -384865.0 -> map : 46270.0
lognum : -359207.0 -> map : 22608.0
lognum : -333550.0 -> map : 11047.0
lognum : -307892.0 -> map : 5397.0
lognum : -282234.0 -> map : 2637.0
lognum : -256577.0 -> map : 1288.0
lognum : -230919.0 -> map : 629.0
lognum : -205261.0 -> map : 307.0
lognum : -179604.0 -> map : 149.0
lognum : -153946.0 -> map : 72.0
lognum : -128288.0 -> map : 35.0
lognum : -102631.0 -> map : 17.0
lognum : -76973.0 -> map : 8.0
lognum : -51315.0 -> map : 3.0
lognum : -25658.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 12019489.0
- diff norm : 2253640.5


Score : 2030736.375
best bias : tensor([1.], device='cuda:0'), best k : 1.399999976158142
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.2000e+01, 1.4900e+02, 3.0700e+02, 6.2900e+02, 1.2880e+03, 2.6370e+03,
        5.3970e+03, 1.1047e+04, 2.2608e+04, 4.6270e+04], device='cuda:0')

-org input INT domain tensor norm : 11063599.0
forward unique : 16
lognum : -384865.0 -> map : 46270.0
lognum : -359207.0 -> map : 22608.0
lognum : -333550.0 -> map : 11047.0
lognum : -307892.0 -> map : 5397.0
lognum : -282234.0 -> map : 2637.0
lognum : -256577.0 -> map : 1288.0
lognum : -230919.0 -> map : 629.0
lognum : -205261.0 -> map : 307.0
lognum : -179604.0 -> map : 149.0
lognum : -153946.0 -> map : 72.0
lognum : -128288.0 -> map : 35.0
lognum : -102631.0 -> map : 17.0
lognum : -76973.0 -> map : 8.0
lognum : -51315.0 -> map : 3.0
lognum : -25658.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 10932621.0
- diff norm : 2030736.375


Score : 1566315.5
best bias : tensor([1.], device='cuda:0'), best k : 1.399999976158142
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.2000e+01, 1.4900e+02, 3.0700e+02, 6.2900e+02, 1.2880e+03, 2.6370e+03,
        5.3970e+03, 1.1047e+04, 2.2608e+04, 4.6270e+04], device='cuda:0')

-org input INT domain tensor norm : 7642649.0
forward unique : 16
lognum : -384865.0 -> map : 46270.0
lognum : -359207.0 -> map : 22608.0
lognum : -333550.0 -> map : 11047.0
lognum : -307892.0 -> map : 5397.0
lognum : -282234.0 -> map : 2637.0
lognum : -256577.0 -> map : 1288.0
lognum : -230919.0 -> map : 629.0
lognum : -205261.0 -> map : 307.0
lognum : -179604.0 -> map : 149.0
lognum : -153946.0 -> map : 72.0
lognum : -128288.0 -> map : 35.0
lognum : -102631.0 -> map : 17.0
lognum : -76973.0 -> map : 8.0
lognum : -51315.0 -> map : 3.0
lognum : -25658.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 7476090.5
- diff norm : 1566315.5


Score : 1309156.875
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 6358028.0
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 6151303.5
- diff norm : 1309156.875


Score : 1499393.75
best bias : tensor([1.], device='cuda:0'), best k : 1.399999976158142
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.2000e+01, 1.4900e+02, 3.0700e+02, 6.2900e+02, 1.2880e+03, 2.6370e+03,
        5.3970e+03, 1.1047e+04, 2.2608e+04, 4.6270e+04], device='cuda:0')

-org input INT domain tensor norm : 7291935.0
forward unique : 16
lognum : -384865.0 -> map : 46270.0
lognum : -359207.0 -> map : 22608.0
lognum : -333550.0 -> map : 11047.0
lognum : -307892.0 -> map : 5397.0
lognum : -282234.0 -> map : 2637.0
lognum : -256577.0 -> map : 1288.0
lognum : -230919.0 -> map : 629.0
lognum : -205261.0 -> map : 307.0
lognum : -179604.0 -> map : 149.0
lognum : -153946.0 -> map : 72.0
lognum : -128288.0 -> map : 35.0
lognum : -102631.0 -> map : 17.0
lognum : -76973.0 -> map : 8.0
lognum : -51315.0 -> map : 3.0
lognum : -25658.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 7124471.0
- diff norm : 1499393.75


Score : 1358197.125
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 6616636.5
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 6411317.0
- diff norm : 1358197.125


Score : 1251122.5
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 6090184.0
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 5886003.0
- diff norm : 1251122.5


Score : 967975.625
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 4648930.0
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 4406270.0
- diff norm : 967975.625


Score : 884107.25
best bias : tensor([50.], device='cuda:0'), best k : 1.2000000476837158
map size: 16
    tensor([0.0000e+00, 1.4000e+01, 4.7000e+01, 9.7000e+01, 1.7300e+02, 2.8800e+02,
        4.6200e+02, 7.2700e+02, 1.1270e+03, 1.7350e+03, 2.6550e+03, 4.0510e+03,
        6.1660e+03, 9.3720e+03, 1.4231e+04, 2.1598e+04], device='cuda:0')

-org input INT domain tensor norm : 3992698.0
forward unique : 16
lognum : -410832.0 -> map : 21598.0
lognum : -393714.0 -> map : 14231.0
lognum : -376596.0 -> map : 9372.0
lognum : -359478.0 -> map : 6166.0
lognum : -342360.0 -> map : 4051.0
lognum : -325242.0 -> map : 2655.0
lognum : -308124.0 -> map : 1735.0
lognum : -291006.0 -> map : 1127.0
lognum : -273888.0 -> map : 727.0
lognum : -256770.0 -> map : 462.0
lognum : -239652.0 -> map : 288.0
lognum : -222534.0 -> map : 173.0
lognum : -205416.0 -> map : 97.0
lognum : -188298.0 -> map : 47.0
lognum : -171180.0 -> map : 14.0
lognum : -154062.0 -> map : 0.0
-after INT domain tensor norm : 3375721.5
- diff norm : 884107.25


Score : 951076.0
best bias : tensor([1.], device='cuda:0'), best k : 0.09999999403953552
map size: 16
    tensor([0.0000e+00, 1.0000e+00, 3.0000e+00, 8.0000e+00, 1.7000e+01, 3.5000e+01,
        7.3000e+01, 1.5000e+02, 3.0700e+02, 6.3000e+02, 1.2900e+03, 2.6410e+03,
        5.4060e+03, 1.1066e+04, 2.2651e+04, 4.6362e+04], device='cuda:0')

-org input INT domain tensor norm : 4570420.0
forward unique : 16
lognum : -947825.0 -> map : 46362.0
lognum : -884637.0 -> map : 22651.0
lognum : -821448.0 -> map : 11066.0
lognum : -758260.0 -> map : 5406.0
lognum : -695072.0 -> map : 2641.0
lognum : -631883.0 -> map : 1290.0
lognum : -568695.0 -> map : 630.0
lognum : -505507.0 -> map : 307.0
lognum : -442318.0 -> map : 150.0
lognum : -379130.0 -> map : 73.0
lognum : -315942.0 -> map : 35.0
lognum : -252753.0 -> map : 17.0
lognum : -189565.0 -> map : 8.0
lognum : -126377.0 -> map : 3.0
lognum : -63188.0 -> map : 1.0
lognum : 0.0 -> map : 0.0
-after INT domain tensor norm : 4323420.5
- diff norm : 951076.0


100%|████████████████████████████████████████████████████▊| 390/391 [18:39<00:02,  2.87s/it]

    Quantized model Evaluation accuracy on 50000 images, 73.908%, 91.710%
Total time: 1122.11 sec